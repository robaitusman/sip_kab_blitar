Laporan Rencana Penerapan Keamanan SIP (berdasarkan template e-tani)

Format: tiap tahap memuat tujuan, daftar perubahan yang perlu dibuat di kode SIP, serta catatan eksekusi/infra. Ikuti urutan Tahap 1–8. Pastikan commit/rollback per tahap agar mudah diaudit.

Tahap 1 - Penguatan Autentikasi (password policy & lockout)
Tujuan: memenuhi kebijakan panjang/kompleksitas, pelacakan percobaan gagal, penguncian akun, masa berlaku 6 bulan, dan riwayat password.
Perubahan yang sudah dibuat:
- Migrasi: `database/migrations/2025_11_21_044158_add_password_metadata_to_users_table.php` (password_changed_at, failed_login_attempts, lockout_until) dan `2025_11_21_044211_create_password_histories_table.php` (riwayat hash).
- Model: `app/Models/PasswordHistory.php` dan relasi/casts baru di `app/Models/Users.php`.
- Rule: `app/Rules/StrongPassword.php` (min 12, upper/lower/number/symbol, larang 3 char berulang).
- Service: `app/Services/PasswordSecurityService.php` (cek riwayat, expiry 6 bulan, lockout 3x gagal, reset counter, trimming riwayat 5).
- Request: StrongPassword dipakai di `UsersAddRequest`, `UsersRegisterRequest`, `UsersEditRequest`.
- Controller: `AuthController` (lockout, regen session, cek expiry, cegah reuse di reset, catat histori di register); `UsersController` (create/update catat histori); `AccountController` (ganti password cek reuse + catat histori).
Catatan: jalankan `php artisan migrate` setelah deploy; paksa reset jika kadaluarsa.

Tahap 2 - Keamanan Manajemen Sesi
Tujuan: idle timeout, absolute timeout, cookie aman, anti session hijacking/duplication.
Perubahan yang sudah dibuat:
- `config/session.php`: secure cookie via env, http_only true, SameSite Strict, encrypt true, expire_on_close via env, kunci `idle_timeout` & `absolute_timeout`.
- Middleware: `app/Http/Middleware/EnforceSessionSecurity.php` (cek idle/absolute, logout+invalidate).
- Kernel: alias `session.security` ditambahkan; applied di group web auth.
- `routes/web.php`: group auth memakai `session.security`.
- `AuthController@login`: regen session, set `first_login`/`last_activity`; `logout` invalidate + regenerate token.
Catatan env: set `SESSION_SECURE_COOKIE=true`, `SESSION_IDLE_TIMEOUT`, `SESSION_ABSOLUTE_TIMEOUT`; pastikan APP_URL https.

Tahap 3 - Validasi Input & File Security (upload)
Tujuan: validasi MIME riil, signature, whitelist path, karantina.
Perubahan yang sudah dibuat:
- `config/upload.php`: whitelist diperketat (pdf, doc, docx, jpg, png; gambar hanya jpg/png/jpeg; summernote jpg/png/jpeg).
- `app/Helpers/Uploader.php`: cek MIME riil (finfo), signature (magic bytes), validasi ekstensi whitelist per field, limit jumlah file, tolak file yang tidak lolos; daftar error dikembalikan.
- `app/Http/Controllers/FileUploaderController.php`: menolak upload (HTTP 400) jika ada error keamanan dari Uploader.
Catatan: folder `uploads/temp` tetap karantina; disarankan AV scan sebelum pindah ke lokasi final (Outstanding).

Tahap 4 - Kontrol Akses & Auditing
Tujuan: RBAC diterapkan ke seluruh route sensitif dan audit perubahan akun.
Perubahan yang perlu dibuat:
- Routes `routes/web.php`: pastikan semua endpoint internal (misal rekomendasi/componentsdata) dilindungi middleware RBAC/role.
- AuthController: setelah login, batasi riwayat password ke 5 entri terbaru dan reset counter gagal.
- Model User: pastikan casting timestamp baru berfungsi untuk evaluasi akses.
Catatan: siapkan alert untuk akses mencurigakan (belum dikerjakan).

Tahap 5 - Monitoring & Logging Upload
Tujuan: audit trail upload/download untuk forensik.
Perubahan yang perlu dibuat:
- `config/logging.php`: tambah channel `security` → file `storage/logs/security.log`.
- `app/Http/Controllers/FileUploaderController.php`: log setiap upload/delete (sukses/gagal) beserta user, IP, user-agent, nama file, alasan gagal ke channel `security`.
Catatan: bisa diintegrasikan ke SIEM/Wazuh jika tersedia.

Tahap 6 - Keamanan Komunikasi & Header
Tujuan: enforce HTTPS dan header proteksi.
Perubahan yang perlu dibuat:
- Middleware `ForceHttpsMiddleware`: redirect ke HTTPS di production dan tambahkan header HSTS, X-Frame-Options DENY, X-Content-Type-Options nosniff, Referrer-Policy strict-origin-when-cross-origin, Permissions-Policy minimal.
- Kernel: daftarkan middleware untuk semua web responses.
Catatan infra: aktifkan TLS valid di server; disable script execution & directory listing di folder upload.

Tahap 7 - Integritas File & Anti-Tamper
Tujuan: deteksi perubahan file pasca upload.
Perubahan yang perlu dibuat:
- Migrasi: tabel `file_integrity_records` (path, sha256_hash, last_scanned_at, timestamps).
- Model `FileIntegrityRecord`.
- FileUploaderController: setelah upload sukses, hitung hash SHA256 dan simpan/update record.
Catatan: butuh scheduler artisan + cron untuk verifikasi berkala (Outstanding).

Tahap 8 - Proteksi API & Web Service
Tujuan: API internal dengan token, rate limit, schema validation, anti otomatisasi.
Perubahan yang perlu dibuat:
- `routes/api.php`: endpoint resmi dengan middleware rate limit ketat (misal 30/menit) dan validasi token env `INTERNAL_API_TOKEN`.
- `config/services.php`: simpan token internal; gunakan cache response untuk metrik.
Catatan: bisa tambah HMAC/JWT + logging per request jika diperlukan.

Outstanding (belum dikerjakan, disarankan):
1) Integrasi antivirus/content scanning di `uploads/temp` sebelum file dipindah.
2) Scheduler (Artisan command + cron 6 jam) untuk re-scan hash `file_integrity_records` dan kirim alert bila berubah.
3) Konfigurasi server: nonaktifkan script execution & directory listing pada folder upload, set permission 644/755, proteksi symlink.
4) Integrasi SIEM/Wazuh untuk alert real-time atas file baru/perubahan tak sah.
5) Alert anti-otomatisasi di fungsi admin (deteksi akses serentak, rate-limit hit, notifikasi).
